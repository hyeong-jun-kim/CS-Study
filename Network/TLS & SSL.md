# SSL & TLS

* SSL(Secure Sockets Layer)은 암호화 기반 인터넷 보안 프로토콜이다.
* SSL은 기밀성, 데이터 무결성, 서버 인증과 클라이언트 인증을 통해 TCP를 향상시켰다고 한다.
* SSL/TLS을 적용하는 웹사이트는 HTTPS 프로토콜을 사용한다.
* HTTPS는 HTTP를 SSL/TLS를 적용해서 통신 과정에 암호화를 더해 보안성을 높인 프로토콜이다.
* TLS는 SSL의 좀 더 발전한 모습이다.


# SSL 핸드셰이크

### 1. TCP 연결

* 먼저 SSL은 TCP 바탕으로 TCP 3 way hand shaking 으로 TCP 연결이 만들어지면 SSL 핸드셰이크가 시작된다.

### 2. Client Hello Message

* 클라이언트가 서버로 헬로 메시지를 전송하면서 SSL 핸드셰이크를 시작한다.
* 이 메시지에는 클라이언트가 지원하는 SSL/TLS 버전, 지원하는 암호화 알고리즘의 목록과 랜덤한 바이트 문자열을 보낸다.

### 3. Server Hello Message

* 서버가 SSL 통신이 가능한 경우에는 Server Hello 메시지로 응답한다.
* 서버는 클라이언트가 지원하는 암호화 알고리즘 목록에서 한 가지 알고리즘을 선택하고, 서버의 SSL 인증서, 그리고 서버에서 생성한 또 다른 무작위 바이트 문자열을 모두 담아 클라이언트에게 전송한다. (선택 알고리즘, SSL 인증서, 무작위 문자열 전송)

### 4. 인증과 예비 마스터 암호

* Server Hello Message를 클라이언트가 수신하면 클라이언트가 서버의 SSL 인증서를 내장된 CA(발행 기관) 리스트를 통해 검증한다. 
* 만약 CA리스트에 인증서가 없다면 사용자에게 경고 메시지를 출력한다.
* 인증서가 CA에 의해서 발급된 것인지 확인하기 위해서 클라이언트에 내장된 CA의 공개키를 이용해서 인증서를 복호화한다.
* 복호화에 성공한다면 인증서는 CA의 개인키로 암호화된 문서임이 보증된 것이다.
* 클라이언트는 SSL 인증서를 통해 서버의 공개 키를 알아 낸다.
* 이제 PMS(Pre-Master-Secret)를 생성한다.
* PMS는 서버의 무작위 바이트 문자열과 클라이언트의 무작위 바이트 문자열을 바탕으로 만들어진다. 
* PMS는 서버의 공개키를 통해 암호화되어 서버에게 전달된다.
* PMS는 이후에 세션 단계 에서 암호화하기 위해 사용할 것이며 암호화 기법이 대칭키이므로 절대로 노출되어서는 안된다.

### 5. 서버의 개인 키 사용

* 클라이언트는 서버의 공개키로 암호화된 PMS를 서버로 보낸다.
* 그러면 서버는 자신의 개인키를 사용해 PMS를 복호화한다. 이제 서버와 클라이언트는 PMS를 공유하게 되었다.

### 6. 세션 키 생성
* 서버와 클라이언트는 일련의 과정(SSL 표준에 지정된 키 유도 함수)을 거쳐 PMS를 Master Secret 값으로 만든다.
* 그리고 Master Secret을 사용해 Session Key를 만든다.

### 7. 클라이언트, 서버 준비 완료 후 안전한 대칭 암호화 성공

* 클라이언트가 세션 키로 암호화된 완료 메시지를 보내고, 서버가 세션 키로 암호화된 완료 메시지를 보낸다.
* 이제 서버와 클라이언트는 데이터를 대칭키 방식으로 암호화한 후에 주고 받는다.
* 이렇게 해서 세션키를 클라이언트와 서버가 모두 공유하게 되었다. __SSL 핸드셰이킹을 완료한 것이다.__

### 8. 세션 단계

* 세션은 실제로 서버와 클라이언트가 데이터를 주고 받는 단계다.
* 이 단계에서 핵심은 정보를 상대방에게 전송하기 전에 세션 키 값을 이용해서 대칭키 방식으로 암호화 한다는 점이다.
* 암호화된 정보는 상대방에게 전송되고, 상대방도 세션키 값을 알고 있기 때문에 암호를 복호화할 수 있다.
* 즉 애플리케이션 계층의 프로토콜에 의해 통신을 진행한다.

### 9. 세션 종료 단계

* 세션 종료 단계는 데이터의 전송이 끝나면 SSL 통신이 끝났음을 서로에게 알려주고 대칭 키인 세션 키를 폐기한다.
* 그 후에 TCP FIN 메시지를 보내 TCP 통신을 종료한다.